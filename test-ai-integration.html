<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #42b38e; }
        h2 { color: #333; margin-top: 0; }
        pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .success { color: #42b38e; font-weight: bold; }
        .error { color: #d9534f; font-weight: bold; }
        .warning { color: #f0ad4e; font-weight: bold; }
        button {
            background: #42b38e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #369a78; }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9f6;
            border-left: 4px solid #42b38e;
            border-radius: 4px;
        }
        .scenario-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .option {
            padding: 8px;
            margin: 5px 0;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .risk-low { border-left: 3px solid #5cb85c; }
        .risk-medium { border-left: 3px solid #f0ad4e; }
        .risk-high { border-left: 3px solid #d9534f; }
    </style>
</head>
<body>
    <h1>ğŸ¤– AI Entegrasyon Test Konsolu</h1>
    <p>Gemini Pro ile risk senaryosu ve cevap seÃ§enekleri Ã¼retim testleri</p>

    <div class="test-section">
        <h2>Test 1: API BaÄŸlantÄ±sÄ±</h2>
        <button onclick="testAPIConnection()">API BaÄŸlantÄ±sÄ±nÄ± Test Et</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Senaryo Ãœretimi (GenÃ§, DÃ¼ÅŸÃ¼k Gelir)</h2>
        <button onclick="testScenarioGeneration('young-low')">GenÃ§ Profil iÃ§in Senaryo Ãœret</button>
        <div id="scenario-young-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Senaryo Ãœretimi (Orta YaÅŸ, YÃ¼ksek Gelir)</h2>
        <button onclick="testScenarioGeneration('middle-high')">Orta YaÅŸ Profil iÃ§in Senaryo Ãœret</button>
        <div id="scenario-middle-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Senaryo Ãœretimi (Emekli, Ã‡ok YÃ¼ksek Gelir)</h2>
        <button onclick="testScenarioGeneration('senior-veryhigh')">Emekli Profil iÃ§in Senaryo Ãœret</button>
        <div id="scenario-senior-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: JSON Parse ve Validasyon</h2>
        <button onclick="testValidation()">Validasyon KurallarÄ±nÄ± Test Et</button>
        <div id="validation-result"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyCSSuTftQ0FC2WtAuVVHqS5hTu9spBWJiM';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

        const userProfiles = {
            'young-low': {
                personType: 'a',
                age: 'a', // 18-30
                income: 'a', // < 250k
                experience: 'a' // DÃ¼ÅŸÃ¼k
            },
            'middle-high': {
                personType: 'a',
                age: 'b', // 31-50
                income: 'c', // 500k-1M
                experience: 'c' // Orta
            },
            'senior-veryhigh': {
                personType: 'a',
                age: 'd', // >65
                income: 'd', // >1M
                experience: 'd' // YÃ¼ksek
            }
        };

        async function testAPIConnection() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>â³ API baÄŸlantÄ±sÄ± test ediliyor...</p>';

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: 'Merhaba, test mesajÄ±. Sadece "OK" diye cevap ver.' }]
                        }],
                        generationConfig: {
                            temperature: 0.5,
                            maxOutputTokens: 50
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Cevap alÄ±namadÄ±';
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="success">âœ“ API BaÄŸlantÄ±sÄ± BaÅŸarÄ±lÄ±!</p>
                            <p><strong>Model:</strong> gemini-2.0-flash-exp</p>
                            <p><strong>Durum:</strong> ${response.status} ${response.statusText}</p>
                            <p><strong>Cevap:</strong> ${text}</p>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result">
                        <p class="error">âœ— API BaÄŸlantÄ±sÄ± BaÅŸarÄ±sÄ±z!</p>
                        <p><strong>Hata:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testScenarioGeneration(profileType) {
            const resultDiv = document.getElementById(`scenario-${profileType.split('-')[0]}-result`);
            resultDiv.innerHTML = '<p>â³ AI senaryosu Ã¼retiliyor...</p>';

            const userProfile = userProfiles[profileType];
            
            const ageDesc = {
                'a': '18-30 yaÅŸ arasÄ±, kariyerin baÅŸÄ±nda, uzun yatÄ±rÄ±m ufkuna sahip',
                'b': '31-50 yaÅŸ arasÄ±, aile sorumluluklarÄ±yla kariyer dengesinde',
                'd': '65 yaÅŸ Ã¼stÃ¼, emekli, gelir gÃ¼venliÄŸi arayan'
            };
            
            const incomeDesc = {
                'a': 'yÄ±llÄ±k 250.000 TL altÄ± gelirle, dÃ¼zenli birikim yapan',
                'c': 'yÄ±llÄ±k 500.000-1.000.000 TL gelirle, Ã¼st-orta gelir grubunda',
                'd': 'yÄ±llÄ±k 1.000.000 TL Ã¼stÃ¼ gelirle, varlÄ±klÄ±'
            };

            const prompt = `Sen finans uzmanÄ±sÄ±n. TÃ¼rkÃ§e yaz.

Profil: ${ageDesc[userProfile.age]}, ${incomeDesc[userProfile.income]}

PÄ°YASA DALGALANMASI senaryosu oluÅŸtur:
- 2-3 cÃ¼mle
- Somut rakamlar ekle (TL, %, ay)
- Zaman baskÄ±sÄ± olsun

JSON formatÄ±nda dÃ¶n:
{
  "scenario": "...metin...",
  "options": {
    "low": "...portfÃ¶yÃ¼ boz, gÃ¼vende kal...",
    "medium": "...bekle, hiÃ§bir ÅŸey yapma...",
    "high": "...fÄ±rsat gÃ¶r, daha fazla yatÄ±rÄ±m yap..."
  }
}

SADECE JSON dÃ¶n.`;

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            topK: 40,
                            topP: 0.9,
                            maxOutputTokens: 800,
                            responseModalities: ["TEXT"]  // Disable thinking mode
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Debug: Full response'u console'a yazdÄ±r
                console.log('ğŸ” Full API Response:', JSON.stringify(data, null, 2));
                
                const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!generatedText) {
                    console.error('âŒ Response structure:', data);
                    console.error('âŒ Candidates:', data.candidates);
                    throw new Error(`AI cevap Ã¼retmedi. Reason: ${data.candidates?.[0]?.finishReason || 'Unknown'}`);
                }

                // Parse JSON
                let cleanedText = generatedText.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '');
                const parsed = JSON.parse(cleanedText);

                // Display result
                resultDiv.innerHTML = `
                    <div class="result">
                        <p class="success">âœ“ Senaryo BaÅŸarÄ±yla Ãœretildi!</p>
                        
                        <div class="scenario-box">
                            <h3>ğŸ“ Senaryo:</h3>
                            <p>${parsed.scenario}</p>
                        </div>

                        <h3>ğŸ¯ Cevap SeÃ§enekleri:</h3>
                        <div class="option risk-low">
                            <strong>A) DÃ¼ÅŸÃ¼k Risk (Skor: 1):</strong><br>
                            ${parsed.options.low}
                        </div>
                        <div class="option risk-medium">
                            <strong>B) Orta Risk (Skor: 2):</strong><br>
                            ${parsed.options.medium}
                        </div>
                        <div class="option risk-high">
                            <strong>C) YÃ¼ksek Risk (Skor: 4):</strong><br>
                            ${parsed.options.high}
                        </div>

                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; color: #666;">ğŸ” Ham JSON Ã‡Ä±ktÄ±sÄ±</summary>
                            <pre>${JSON.stringify(parsed, null, 2)}</pre>
                        </details>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result">
                        <p class="error">âœ— Senaryo Ãœretimi BaÅŸarÄ±sÄ±z!</p>
                        <p><strong>Hata:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        function testValidation() {
            const resultDiv = document.getElementById('validation-result');
            
            const testCases = [
                {
                    name: 'GeÃ§erli JSON',
                    input: {
                        scenario: "PortfÃ¶yÃ¼nÃ¼zdeki hisse senedi fonlarÄ± son 3 ayda %15 deÄŸer kaybetti ve toplam 50.000 TL zararda. Piyasa analistleri Ã¶nÃ¼mÃ¼zdeki 6 ay iÃ§in dalgalanmanÄ±n devam edeceÄŸini Ã¶ngÃ¶rÃ¼yor. Ancak uzun vadede toparlanma bekleniyor. AynÄ± dÃ¶nemde gayrimenkul sektÃ¶rÃ¼ne yatÄ±rÄ±m yapan rakip fonlar %8 getiri saÄŸladÄ±. 6 ay sonra evinizin tadilat projesi iÃ§in 30.000 TL'ye ihtiyacÄ±nÄ±z olacak. Bu durumda ne yaparsÄ±nÄ±z?",
                        options: {
                            low: "TÃ¼m hisse senedi fonlarÄ±nÄ± bozar, paralarÄ±mÄ± mevduat hesabÄ±nda gÃ¼vende tutarÄ±m.",
                            medium: "HiÃ§bir iÅŸlem yapmam, piyasanÄ±n toparlanmasÄ±nÄ± beklerim ve planÄ±mda kalÄ±rÄ±m.",
                            high: "Bu dÃ¼ÅŸÃ¼ÅŸÃ¼ fÄ±rsat gÃ¶rÃ¼p daha fazla yatÄ±rÄ±m yapar, alÄ±m yaparÄ±m."
                        }
                    },
                    expected: 'success'
                },
                {
                    name: 'Ã‡ok KÄ±sa Senaryo',
                    input: {
                        scenario: "KÄ±sa senaryo.",
                        options: { low: "a", medium: "b", high: "c" }
                    },
                    expected: 'fail'
                },
                {
                    name: 'Rakam Yok',
                    input: {
                        scenario: "PortfÃ¶yÃ¼nÃ¼z deÄŸer kaybetti ama rakam yok. Piyasalar dalgalÄ±. Ne yaparsÄ±nÄ±z?",
                        options: { low: "Sat", medium: "Bekle", high: "Al" }
                    },
                    expected: 'fail'
                }
            ];

            let html = '<div class="result">';
            testCases.forEach(test => {
                const wordCount = test.input.scenario.split(/\s+/).length;
                const hasNumbers = /\d/.test(test.input.scenario);
                const hasFinancialTerms = /yatÄ±rÄ±m|portfÃ¶y|getiri|risk|fon|para|tl|lira|mevduat/i.test(test.input.scenario);
                
                const passes = wordCount >= 30 && hasNumbers && hasFinancialTerms;
                const status = passes ? 'âœ“' : 'âœ—';
                const className = passes ? 'success' : 'error';
                
                html += `
                    <div style="padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                        <p class="${className}">${status} ${test.name}</p>
                        <p><small>Kelime: ${wordCount} | Rakam: ${hasNumbers ? 'Var' : 'Yok'} | Finans Terimi: ${hasFinancialTerms ? 'Var' : 'Yok'}</small></p>
                    </div>
                `;
            });
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>